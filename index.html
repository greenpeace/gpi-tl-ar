<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
	<meta charset="utf-8">
	<meta content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
	<meta name="mobile-web-app-capable" content="yes">
	<title>AR Engagement Tool - GPI Techlab</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
	<link rel="stylesheet" href="./css/bulma.css" />
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<script src="./js/canvas2image.js"></script>
	<script src='./js/three.min.js'></script>
	<script src="./js/shaders/SSAOShader.js"></script>
	<script src="./js/shaders/CopyShader.js"></script>
	<script src="./js/postprocessing/EffectComposer.js"></script>
	<script src="./js/postprocessing/RenderPass.js"></script>
	<script src="./js/postprocessing/ShaderPass.js"></script>
	<script src="./js/postprocessing/MaskPass.js"></script>
	<script src="./js/postprocessing/SSAOPass.js"></script>
	<script src="./js/OBJLoader.js"></script>
	<script src="./js/MTLLoader.js"></script>
	<script src="./js/ColladaLoader.js"></script>
	<script src="./js/ar.js"></script>
	<script src="https://unpkg.com/merge-images"></script>
	<script src="./js/download.js"></script>

	<!-- custom javascript tools -->
	<script src="./js/tools.js"></script>
	<!-- asset related json objects as variables in these scripts -->
	<!-- editorial note: I hate JavaScript -->
	<script src="./js/islands.js"></script>
	<script src="./js/trees.js"></script>

	<script>
		THREEx.ArToolkitContext.baseURL = './'
	</script>

	<!-- external CSS style sheet -->
	<link rel="stylesheet" type="text/css" href="style.css" media="screen">

</head>

<body>
	<div id="landing">
		<div class="hero is-large has-bg-img">
			<div class="hero-body has-bg-img">

				<div class="container has-text-centered">
					<div class="column is-6 is-offset-3">
						<h1 id="formtitle" class="title has-text-dark">TechLab AR Project</h1>
						<br>

						<h2 class="subtitle has-text-white">
							<b id="description">Estimate your personal carbon footprint and see what plausible impact it has on floating islands, in terms of deforestation and plastic and oil consumption.<br><br></b>

							<!-- button to begin calculation of footprint -->
							<a class="button is-primary has-text-dark" id="calculationBox" onclick="Begin()">
								<b> Calculate your footprint </b>
							</a>
					</div>

					<!-- Question One - Carbon -->
					<div class="column is-8 is-offset-2">
						<div class="box" id="boxyBox">
							<div class="field is-grouped" id="questionOne">

								<p class="control is-expanded">
									<a class="control has-text-dark" type="text"><b>How many hours do you fly per year?</b>
								</p>
								<div class="columns">
									<p class="control column">
										<a class="button is-success" onclick="setRange('oil', 1, 'questionOne', 'questionTwo')">

											0-10 hours
										</a>
									</p>
									<p class="control column">
										<a class="button is-warning" onclick="setRange('oil', 2, 'questionOne', 'questionTwo')">
											10-20 hours
										</a>
									</p>
									<p class="control column">
										<a class="button is-danger" onclick="setRange('oil', 3, 'questionOne', 'questionTwo')">
											20+ hours
										</a>
									</p>
								</div>
							</div>

							<!-- Question Two - Plastic -->
							<!-- <div class="box hidden"   > -->
							<div class="field is-grouped" id="questionTwo" hidden>

								<p class="control is-expanded">
									<a class="control has-text-dark" type="text"><b>How many items using plastic packaging do you consume per week?</b>
								</p>
								<div class="columns">
									<p class="control column">
										<a class="button is-success" onclick="setRange('plastic', 1, 'questionTwo', 'questionThree')">
											0-10 items
										</a>
									</p>
									<p class="control column">
										<a class="button is-warning" onclick="setRange('plastic', 2, 'questionTwo', 'questionThree')">
											10-20 items
										</a>
									</p>
									<p class="control column">
										<a class="button is-danger" onclick="setRange('plastic', 3, 'questionTwo', 'questionThree')">
											20+ items
										</a>
									</p>
								</div>
							</div>

							<!-- Question Three - Oil -->
							<!-- <div class="box hidden"> -->
							<div class="field is-grouped" id="questionThree" hidden>

								<p class="control is-expanded">
									<a class="control has-text-dark" type="text"><b>How would you best describe your diet?</b>
								</p>

								<div class="columns">
									<p class="control column">
										<a class="button is-success" onclick="setRange('forest', 1, [], [], ['landing', 'questionThree'])">
											Vegan/Vegetarian
										</a>
									</p>
									<p class="control column">
										<a class="button is-warning" onclick="setRange('forest', 0.8, [], [], ['landing', 'questionThree'])">
											I eat meat rarely
										</a>
									</p>
									<p class="control column">
										<a class="button is-danger" onclick="setRange('forest', 0.6, [], [], ['landing', 'questionThree'])">
											I eat meat everyday
										</a>
									</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- overlay -->
	<div id="blinds" style="position:absolute;margin:0;width:100%;height:100%;background:rgba(0,0,0,0.7);line-height:100%;top:0">
		Find the Marker
		<img style="position:absolute;width:120px;height:120px;margin-left:-60px;margin-top:-10px;left:50%;top:50%;" src="./assets/gp.png" alt="">
	</div>

	<!-- buttons at the bottom -->
	<div id="ui">
		<i class="fab fa-envira" data-size="large"></i>
		<i class="fab fa-twitter" data-size="large"></i>
		<i class="fab fa-facebook" data-size="large"></i>
		<i class="fas fa-shoe-prints" data-size="large"></i>
	</div>
	<script>
		///////////////////////////////////////////////////////////////////////////
		/////								  			Init																			/////
		///////////////////////////////////////////////////////////////////////////
		let oil, plastic, forest;
		let pollutionIndicators = {
			"oil": {
				"range": 0
			},
			"plastic": {
				"range": 0
			},
			"forest": {
				"range": 0,
				"impact": [setGrassGreenness, setWaterClarity]
			}
		}

		initForm();  // Hide boxes and questions 2,3

		document.body.addEventListener('touchmove', function(e) { e.preventDefault(); }, false);
		$(".fa-twitter").click(function() {
			snappysnap('twitter')
		}) //
		$(".fa-facebook").click(function() {
			snappysnap('facebook')
		})
		$(".fa-envira").click(function() {
			hideMyImpact()
		})
		$(".fa-shoe-prints").click(function() {
			showMyImpact()
		})
		var date;
		var orbitRadius = 12;
		//var treeposses = [];
		//var treespacing = 0.8;

		// array of functions for the rendering loop
		var onRenderFcts = [];

		// init scene and camera
		var scene = new THREE.Scene();

		function base64ToBlob(base64, mime) {
			console.log("inblobber");
			mime = mime || '';
			var sliceSize = 1024;
			var byteChars = window.atob(base64);
			var byteArrays = [];

			for (var offset = 0, len = byteChars.length; offset < len; offset += sliceSize) {
				var slice = byteChars.slice(offset, offset + sliceSize);

				var byteNumbers = new Array(slice.length);
				for (var i = 0; i < slice.length; i++) {
					byteNumbers[i] = slice.charCodeAt(i);
				}

				var byteArray = new Uint8Array(byteNumbers);

				byteArrays.push(byteArray);
			}

			return new Blob(byteArrays, {
				type: mime
			});
		}

		// called by snap-button, takes a screenshot of video and canvas
		function snappysnap(platform) {
			// save frame from video, i.e. camera
			let frame = captureVideoFrame("video", "png")
			// save canvas object
			let canvas = renderer.domElement // just object is needed

			// resize canvas to match frame dimensions
			canvas = resizeCanvas(canvas, frame.width, frame.height)
			frame = frame.dataUri

			// merge frame and canvas and download the resulting file
			mergeImages([frame, canvas]).then(b64 => {
				console.log("downloading screenshotty: " + b64);
				//download(b64, "AR.png", "image/png")
				//$("#fileholder")[0].setAttribute("value", b64);
				console.log(b64);
				var base64ImageContent = b64.replace(/^data:image\/(png|jpg);base64,/, "");
				console.log("b64: " + base64ImageContent);
				var blob = base64ToBlob(base64ImageContent, 'image/png');
				var formData = new FormData();
				formData.append('picture', blob);
				//var form_data = new FormData($('#uploadForm')[0]);
				//console.log(form_data);
				if (platform == 'twitter') {
					$.ajax({
						type: 'POST',
						url: 'https://ul.greenpeace.international/upload',
						processData: false,
						contentType: false,
						async: false,
						cache: false,
						data: formData,
						success: function(response) {
							console.log(response);
							//$("body").append('<a href="https://twitter.com/intent/tweet?text='+response+'%20Check%20out%20my%20AR%20Impact%21&source=webclient"><i class="fab fa-twitter"  data-size="large"></i></a>')
							window.location.href = 'https://twitter.com/intent/tweet?text=' + response + '%20Check%20out%20my%20AR%20Impact%21&source=webclient';

						},
						error: function(error) {
							console.log(error)
						}
					});
				} else if (platform == 'facebook') {
					$.ajax({
						type: 'POST',
						url: 'https://ul.greenpeace.international/upload',
						processData: false,
						contentType: false,
						async: false,
						cache: false,
						data: formData,
						success: function(response) {
							console.log(response);
							window.location.href = 'https://www.facebook.com/sharer/sharer.php?u=' + response + '&amp;src=sdkpreparse';

						},
						error: function(error) {
							console.log(error)
						}
					});
				}

			})
		}

		//////////////////////////////////////////////////////////////////////////////////
		//		Initialize a basic camera + lights
		//////////////////////////////////////////////////////////////////////////////////

		// Create a camera
		var camera = new THREE.PerspectiveCamera;
		scene.add(camera);

		// add lights to scene and dynamic camera based light
		var ambientLight = new THREE.AmbientLight(0x212223, 8);
		scene.add(ambientLight);
		var pointLight = new THREE.DirectionalLight(0xffffff, 4);
		pointLight.position.set(-.5, -12, 1.5)
		pointLight.castShadow = true;
		scene.add(pointLight);
		scene.add(pointLight.target);

	  var cameraLight = new THREE.DirectionalLight(0xc4dce5, 4);
		camera.add(cameraLight);

		// init renderer
		var renderer = new THREE.WebGLRenderer({
			antialias: true,
			alpha: true,
			preserveDrawingBuffer: true // needed for screenshots
		});

		renderer.setPixelRatio(4);
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.domElement.style.position = 'absolute';
		renderer.domElement.style.top = '0px';
		renderer.domElement.style.left = '0px';
		renderer.shadowMapEnabled = true;
		renderer.shadowMapSoft = true;

		renderer.shadowCameraNear = 0.1;
		renderer.shadowCameraFar = 9999999999999;
		renderer.shadowCameraFov = 150;

		renderer.shadowMapBias = 0.0039;
		renderer.shadowMapDarkness = 0.2;
		renderer.shadowMapWidth = 1024;
		renderer.shadowMapHeight = 1024;
		document.body.appendChild(renderer.domElement);


		////////////////////////////////////////////////////////////////////////////////
		//          handle arToolkitSource
		////////////////////////////////////////////////////////////////////////////////

		var arToolkitSource = new THREEx.ArToolkitSource({
			// to read from the webcam
			sourceType: 'webcam',
			sourceWidth: 1980,
			sourceHeight: 1080
		})

		arToolkitSource.init(function onReady() {
			onResize()
		})

		// handle resize
		window.addEventListener('resize', function() {
			onResize()
		})

		function onResize() {
			arToolkitSource.onResizeElement();
			arToolkitSource.copyElementSizeTo(renderer.domElement)
			if (arToolkitContext.arController !== null) {
				arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
			}
		}
		////////////////////////////////////////////////////////////////////////////////
		//          initialize arToolkitContext
		////////////////////////////////////////////////////////////////////////////////


		// create atToolkitContext
		var arToolkitContext = new THREEx.ArToolkitContext({
			cameraParametersUrl: './assets/camera_para.dat',
			detectionMode: 'mono',
			maxDetectionRate: 90,
			canvasWidth: 80 * 3,
			canvasHeight: 60 * 3,
		})
		// initialize it
		arToolkitContext.init(function onCompleted() {
			// copy projection matrix to camera
			camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
		})

		// update artoolkit on every frame
		onRenderFcts.push(function() {
			if (arToolkitSource.ready === false) return
			arToolkitContext.update(arToolkitSource.domElement)
		})


		////////////////////////////////////////////////////////////////////////////////
		//          Create a ArMarkerControls
		////////////////////////////////////////////////////////////////////////////////

		var markerRoot = new THREE.Group()
		scene.add(markerRoot)
		var artoolkitMarker = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
			type: 'pattern',
			patternUrl: './assets/patt.gp',
			size: 1
		})

		// build a smoothedControls
		var smoothedRoot = new THREE.Group()
		scene.add(smoothedRoot)
		var smoothedControls = new THREEx.ArSmoothedControls(smoothedRoot, {
			lerpPosition: 0.25,
			lerpQuaternion: 0.125,
			lerpScale: 1,
		})
		onRenderFcts.push(function(delta) {
			smoothedControls.update(markerRoot)
		})
		//////////////////////////////////////////////////////////////////////////////////
		//		add an object in the scene
		//////////////////////////////////////////////////////////////////////////////////

		var arWorldRoot = smoothedRoot;
		arWorldRoot.name = "arWorldRoot" // makes finding it easier

		var geometry = new THREE.SphereGeometry(0.3, 32, 32);
		var material = new THREE.MeshBasicMaterial({
			color: 0xffff00
		});
		var sphere = new THREE.Mesh(geometry, material);
		arWorldRoot.add(sphere);

		let mtlLoader = new THREE.MTLLoader();
		//let objLoader = new THREE.OBJLoader();

		function loadIsland(islandDirectory, islandName) {
			/* something like a docstring
					islandDirectory			str, path to directory that contains .mtl, .obj
					islandName					str, the name of the island files
					positions						array of length 3, containing xyz coords for placement
			*/
			mtlLoader.setTexturePath(islandDirectory)
			mtlLoader.setPath(islandDirectory)
			// load material
			mtlLoader.load(islandName + ".mtl", materials => {
				materials.preload()
				let objLoader = new THREE.OBJLoader();
				objLoader.setMaterials(materials)
				objLoader.setPath(islandDirectory)
				// load object
				objLoader.load(islandName + ".obj", object => {
					console.log(`currently loading ${islandName}`)
					console.log(object)
					object.traverse(node => {
						if (node instanceof THREE.Mesh) {
							node.geometry.computeVertexNormals()
						}
					})
					object.scale.set(...islands[islandName].scale)
					object.rotation.set(islands[islandName].rotation.x,islands[islandName].rotation.y,islands[islandName].rotation.z)
					object.position.set(...islands[islandName].position) // needs to be an array
					console.log(islands[islandName].scale, islands[islandName])
					object.name = islandName
					arWorldRoot.add(object)
					//model("island_forest").rotation.set(islands[islandName].rotation.x,islands[islandName].rotation.y,islands[islandName].rotation.z)
				})
			})
		}

		function loadTreesOnForestIsland(assetDirectory, treesHolder, nr) {
			var loadedTrees = [];
			Object.keys(trees).forEach(tree => {
				console.log(tree);
			})
		}

		function loadAssets(assetDirectory, assetName, position) {
			/* something like a docstring
					assetName 					Name of the Asset to load
					mtlLoader		 				THREE.MTLLoader instance
					islandDirectory			str, path to directory that contains .mtl, .obj
					islandName					str, the name of the island files
					positions						array of length 3, containing xyz coords for placement
			*/
			mtlLoader.setTexturePath(assetDirectory)
			mtlLoader.setPath(assetDirectory)
			// load material
			mtlLoader.load(assetName + ".mtl", materials => {
				materials.preload();
				let objLoader = new THREE.OBJLoader();
				objLoader.setMaterials(materials)
				objLoader.setPath(assetDirectory)
				// load object
				objLoader.load(assetName + ".obj", object => {
					console.log(`currently loading ${assetName}`)
					console.log(object)
					object.traverse(node => {
						if (node instanceof THREE.Mesh) {
							node.geometry.computeVertexNormals()
						}
					})
					object.scale.set(...trees[assetName].scale)
					if (position === undefined) {
					//if (!(trees[assetName].hasOwnProperty("position"))) {
						spacefound = false;
						var calcdx;
						var calcdz;
						while (!spacefound) {
							potentialx = -1.3 + (Math.random());
							potentialz = -1.8 + (Math.random());
							if (treeposses.length > 0) {
								for (var j = 0; j < treeposses.length; j++) {
									var distance = distanceBetweenTwoPoints(potentialx, treeposses[j].x, potentialz, treeposses[j].z);
									if (distance > treespacing) {
										calcdx = potentialx;
										calcdz = potentialz;
										spacefound = true;
										console.log("positionfound!: " + distance)
									} else {
										console.log("looking for more space because too small: " + distance)
									}
								}
							} else {
								calcdx = potentialx;
								calcdz = potentialz;
								spacefound = true;
							}
						}
						object.position.set(calcdx, 0.4, calcdz)
						treeposses.push(object.position);
					} else {
						console.log(`tree has position ${position}`)
						object.position.set(...position)
					}
					object.name = assetName
					// add tree to specific group
					let parent = trees[assetName].parent

					islands[parent].group.children.push(object) // .add no workey?
					arWorldRoot.add(object)
				})
			})
		}

	//	function loadAssets(assetDirectory, assetName)

		// iterate over all islands
		Object.keys(islands).forEach(island => {
			loadIsland("./assets/islands/", island)
		})

		// create grid for tree placement
		let grid = createGrid([-1.3, -1.3], [0.2, 0.2], 0.1)
		let shuffledGrid = shuffle(grid)
		let forestsize = 10

		shuffledGrid = shuffledGrid.slice(0, forestsize)

		// iterate over all trees
		let typesOfTrees = Object.keys(trees)
		let numberOfTrees = typesOfTrees.length
		let randType

		for (let k = 0; k < shuffledGrid.length; k++) {
			// create random decision between the trees:
			randType = Math.floor(Math.random() * numberOfTrees)

			// extract gridposition
			let [x, z] = shuffledGrid[k]

			// load asset at that position
			loadAssets("./assets/trees/", typesOfTrees[randType], [x, 0.4, z])
		}

		//////////////////////////////////////////////////////////////////////////////////
		//		render the whole thing on the page
		//////////////////////////////////////////////////////////////////////////////////

		// render the scene
		onRenderFcts.push(function() {
			renderer.render(scene, camera);
		})

		// run the rendering loop
		var lastTimeMsec = null
		requestAnimationFrame(function animate(nowMsec) {
			// keep looping
			requestAnimationFrame(animate);
			// lift or lower blinds based on whether marker is visible or not.
			if (markerRoot.visible) {
				$("#blinds").fadeOut(100);
				$("#ui").fadeIn();
			} else {
				$("#blinds").fadeIn();
				$("#ui").fadeOut(100);
			}
			// measure time
			lastTimeMsec = lastTimeMsec || nowMsec - 1000 / 60
			var deltaMsec = Math.min(200, nowMsec - lastTimeMsec)
			lastTimeMsec = nowMsec
			// call each update function
			onRenderFcts.forEach(function(onRenderFct) {
				onRenderFct(deltaMsec / 1000, nowMsec / 1000)
			})

			// iterate over all available islands
			let availableIslands = []
			// push all available islands to array
			scene.getObjectByName(arWorldRoot.name).children.forEach(obj => {
				if (obj.name !== "") {
					availableIslands.push(obj.name)
				}
			})

			// actual iteration
			availableIslands.forEach(island => {
				let islandModel = model(island)
				let dir = 1 // short direction variable name for convenience
				// switch-case:
				switch (island) {
					case "island_forest":
						if (islandModel.position.y < 2) {
							islands[island].direction = 1
						} else if (islandModel.position.y > 2.4) {
							islands[island].direction = -1
						}
						dir = islands[island].direction
						islandModel.position.set(islandModel.position.x,
							islandModel.position.y + 0.001 * dir,
							islandModel.position.z)

						// tree placement
						islands[island].group.children.forEach(tree => {
							tree.position.set(
								tree.position.x,
								islandModel.position.y + 0.001 * dir,
							  tree.position.z)
						})
						break;

					case "island_main":
						if (islandModel.position.y < 1.5) {
							islands[island].direction = 1
						} else if (islandModel.position.y > 2.9) {
							islands[island].direction = -1
						}
						dir = islands[island].direction
						islandModel.position.set(islandModel.position.x,
							islandModel.position.y + 0.002 * dir,
							islandModel.position.z)
						break;

					case "island_lake":
						if (islandModel.position.y < 1.8) {
							islands[island].direction = 1
						} else if (islandModel.position.y > 2.4) {
							islands[island].direction = -1
						}
						dir = islands[island].direction
						islandModel.position.set(islandModel.position.x,
							islandModel.position.y + 0.003 * dir,
							islandModel.position.z)
						break;

					default:
						//console.log(`entered default case for variable ${island}.`)
				}
			})
			date = Date.now() * 0.0006;
			pointLight.position.set(
				Math.cos(date) * orbitRadius,
				Math.sin(date) * orbitRadius,
				Math.sin(date) * orbitRadius
			);
			sphere.position.set(
				Math.cos(date) * orbitRadius,
				Math.sin(date) * orbitRadius,
				Math.sin(date) * orbitRadius
			);
		})

		///////////////////////////////////////////////////////////////////////////
		// 										 	CUSTOM FUNCTIONS 																 //
		///////////////////////////////////////////////////////////////////////////
		function animate() {
			console.log("placeholder function cause gabe forgot")
		}
		//Island Deleter
		function deleteIslands() {
			for (var i = 0; i < arWorldRoot.children.length; i++) {
				if (arWorldRoot.children[i].name) {
					var toRemove = model(arWorldRoot.children[i].name);
					arWorldRoot.remove(toRemove);
					// animate();
				}
			}
		}
		function showMyImpact(){
			setGrassGreenness(pollutionIndicators.forest)
			setWaterClarity(pollutionIndicators.forest)
		}
		function hideMyImpact(){
			setGrassGreenness(1)
			setWaterClarity(1)
		}
		function setGrassGreenness(greenness) {
			model("island_forest").children[2].material[0].color.r = (139 - (greenness*139))/255;
			model("island_forest").children[2].material[0].color.g = (69+(186*greenness))/255;
			model("island_forest").children[2].material[0].color.b = (19-(19*greenness))/255;
		}

		function setWaterClarity(clarity) {
			model("island_forest").children[0].material[2].color.r = 0;
			model("island_forest").children[0].material[2].color.g = clarity * 0.2;
			model("island_forest").children[0].material[2].color.b = clarity;
			model("island_forest").children[0].material[2].opacity = 1 - clarity * .3;
		}

		function distanceBetweenTwoPoints(x1, z1, x2, z2) {
			return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(z2 - z1, 2));
		}

		function model(name) {
			for (var i = 0; i < arWorldRoot.children.length; i++) {
				if (arWorldRoot.children[i].name == name) {
					return arWorldRoot.children[i];
				}
			}
		}

		function findMat(iname, tname) {
			materials = model(iname).children[0].material;
			for (var x = 0; x < materials.length; x++) {
				if (materials[x].name == tname) {
					return materials[x]
				}
			}
		}

		function Begin() {
			$("#formtitle").hide();
			$("#description").hide();
			$("#calculationBox").hide();
			$("#boxyBox").fadeIn();
		}
	</script>
</body>

</html>
