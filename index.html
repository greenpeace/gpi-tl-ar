<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
	<meta charset="utf-8">
	<meta content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
	<meta name="mobile-web-app-capable" content="yes">
	<title>AR - fur shurr</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
	<link rel="stylesheet" href="./css/bulma.css" />
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<script src="./js/canvas2image.js"></script>
	<script src='./js/three.min.js'></script>
	<script src="./js/shaders/SSAOShader.js"></script>
	<script src="./js/shaders/CopyShader.js"></script>
	<script src="./js/postprocessing/EffectComposer.js"></script>
	<script src="./js/postprocessing/RenderPass.js"></script>
	<script src="./js/postprocessing/ShaderPass.js"></script>
	<script src="./js/postprocessing/MaskPass.js"></script>
	<script src="./js/postprocessing/SSAOPass.js"></script>
	<script src="./js/OBJLoader.js"></script>
	<script src="./js/MTLLoader.js"></script>
	<script src="./js/ColladaLoader.js"></script>
	<script src="./js/ar.js"></script>
	<script src="https://unpkg.com/merge-images"></script>
	<script src="./js/download.js"></script>
	<script>
		THREEx.ArToolkitContext.baseURL = './'
	</script>
	<style media="screen">
		html,
		body {
			margin: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			overflow-x: hidden;
		}
		body {
		  position: relative;
		}
		#blinds {
			font-family: "Courier New";
			text-align: center;
			font-size: 6vw;
			color: white
		}

		#blinds:before {
			content: "";
			display: inline-block;
			height: 75%;
			vertical-align: middle;
		}
		#landing{
			height: 100%;
			width:100%;
			position: absolute;
			background: rgba(100,100,100,1);
			z-index: 4;
		}
		#ui {
			width: 100%;
			height: 50px;
			position: absolute;
			text-align: center;
			background: rgba(0, 0, 0, 0.4);
			margin: 0;
			bottom: 0;
			letter-spacing: 10px;
		}

		.fab {
			font-size: 40px;
			line-height: 45px;
			margin-bottom: 20px;
			margin-right: 20px;
		}

		.fa-twitter {
			color: #00aced;
		}

		.fa-twitter:hover {
			cursor: pointer;
		}

		.fa-facebook {
			color: #3b5998;
		}

		.fa-facebook:hover {
			cursor: pointer;
		}
		.has-bg-img {
			height: 100%;
			width:100%;
	    background: url('issland.jpg');
	    -webkit-background-size: cover;
	    -moz-background-size: cover;
	    -o-background-size: cover;
	    background-size: cover;

	  }
		canvas {
			z-index: -1
		}
	</style>

</head>

<body>
	<div id="landing">
		<div class="hero is-large has-bg-img">
			<div class="hero-body has-bg-img">

				<div class="container has-text-centered">
					<div class="column is-6 is-offset-3">
						<h1 id="formtitle" class="title has-text-dark">TechLab AR Project</h1>
						<br>

						<h2 class="subtitle has-text-white">
							<b id="description">Estimate your personal carbon footprint and see what plausible impact it has on floating islands, in terms of deforestation and plastic and oil consumption.<br><br></b>



							<!-- button to begin calculation of footprint -->
							<a class="button is-primary has-text-dark" id="calculationBox" onclick="Begin()">
								<b> Calculate your footprint </b>
							</a>
					</div>

					<!-- Question One - Carbon -->
					<div class="column is-8 is-offset-2">
						<div class="box" id="boxyBox">
							<div class="field is-grouped" id="questionOne">

								<p class="control is-expanded">
									<a class="control has-text-dark" type="text"><b>How many hours do you fly per year?</b>
								</p>
								<div class="columns">
									<p class="control column">
										<a class="button is-success" onclick="setOilToRange1()">
											0-10 hours
										</a>
									</p>
									<p class="control column">
										<a class="button is-warning" onclick="setOilToRange2()">
											10-20 hours
										</a>
									</p>
									<p class="control column">
										<a class="button is-danger" onclick="setOilToRange3()">
											20+ hours
										</a>
									</p>
								</div>
							</div>




							<!-- Question Two - Plastic -->
							<!-- <div class="box hidden"   > -->
							<div class="field is-grouped" id="questionTwo" hidden>

								<p class="control is-expanded">
									<a class="control has-text-dark" type="text"><b>How many items using plastic packaging do you consume per week?</b>
								</p>
								<div class="columns">
									<p class="control column">
										<a class="button is-success" onclick="setPlasticToRange1()">
											0-10 items
										</a>
									</p>
									<p class="control column">
										<a class="button is-warning" onclick="setPlasticToRange2()">
											10-20 items
										</a>
									</p>
									<p class="control column">
										<a class="button is-danger" onclick="setPlasticToRange3()">
											20+ items
										</a>
									</p>
								</div>
							</div>


							<!-- Question Three - Oil -->
							<!-- <div class="box hidden"> -->
							<div class="field is-grouped" id="questionThree" hidden>

								<p class="control is-expanded">
									<a class="control has-text-dark" type="text"><b>How would you best describe your diet?</b>
								</p>

								<div class="columns">
									<p class="control column">
										<a class="button is-success" onclick="setForestToRange1()">
											Vegan/Vegetarian
										</a>
									</p>
									<p class="control column">
										<a class="button is-warning" onclick="setForestToRange2()">
											I eat meat rarely
										</a>
									</p>
									<p class="control column">
										<a class="button is-danger" onclick="setForestToRange3()">
											I eat meat everyday
										</a>
									</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="blinds" style="position:absolute;margin:0;width:100%;height:100%;background:rgba(0,0,0,0.7);line-height:100%;top:0">
		Find the Marker
		<img style="position:absolute;width:120px;height:120px;margin-left:-60px;margin-top:-10px;left:50%;top:50%;" src="./assets/gp.png" alt="">
	</div>
	<div id="ui">
		<i class="fab fa-twitter" data-size="large"></i>
		<i class="fab fa-facebook" data-size="large"></i>
	</div>
	<script>
		//////////////////////////////////////////////////////////////////////////////////
		//		Init
		//////////////////////////////////////////////////////////////////////////////////
		var oil, plastic, forest;
		initForm();
		document.body.addEventListener('touchmove', function(e) { e.preventDefault(); }, false);
		$(".fa-twitter").click(function() {
			snappysnap('twitter')
		}) //
		$(".fa-facebook").click(function() {
			snappysnap('facebook')
		})
		var date;
		var orbitRadius = 12;
		var treeposses = [];
		var treespacing = 0.8;
		var trees = {
			"beech_tree": {
				parent: "island_forest",
				scale: [0.02, 0.02, 0.02]
			},
			"pine_tree": {
				parent: "island_forest",
				scale: [0.03, 0.065, 0.03]
			}
		}

		let islands = {
			"island_forest": {
				position: [-1, 1.4, -1],
				scale: [0.1, 0.06, 0.06],
				rotation:{
					x:0,
					y:3,
					z:0
				}
			},
			"island_main": {
				position: [0, 1, 0],
				scale: [0.03, 0.03, 0.03],
				rotation:{
					x:0,
					y:3,
					z:0
				}
			},
			"island_lake": {
				position: [-1, .7, 1.2],
				scale: [0.3, 0.3, 0.3],
				rotation:{
					x:0,
					y:0,
					z:0
				}
			}
		}

		// array of functions for the rendering loop
		var onRenderFcts = [];

		// init scene and camera
		var scene = new THREE.Scene();

		function base64ToBlob(base64, mime) {
			console.log("inblobber");
			mime = mime || '';
			var sliceSize = 1024;
			var byteChars = window.atob(base64);
			var byteArrays = [];

			for (var offset = 0, len = byteChars.length; offset < len; offset += sliceSize) {
				var slice = byteChars.slice(offset, offset + sliceSize);

				var byteNumbers = new Array(slice.length);
				for (var i = 0; i < slice.length; i++) {
					byteNumbers[i] = slice.charCodeAt(i);
				}

				var byteArray = new Uint8Array(byteNumbers);

				byteArrays.push(byteArray);
			}

			return new Blob(byteArrays, {
				type: mime
			});
		}

		// called by snap-button, takes a screenshot of video and canvas
		function snappysnap(platform) {
			// save frame from video, i.e. camera
			let frame = captureVideoFrame("video", "png")
			// save canvas object
			let canvas = renderer.domElement // just object is needed

			// resize canvas to match frame dimensions
			canvas = resizeCanvas(canvas, frame.width, frame.height)
			frame = frame.dataUri

			// merge frame and canvas and download the resulting file
			mergeImages([frame, canvas]).then(b64 => {
				console.log("downloading screenshotty: " + b64);
				//download(b64, "AR.png", "image/png")
				//$("#fileholder")[0].setAttribute("value", b64);
				console.log(b64);
				var base64ImageContent = b64.replace(/^data:image\/(png|jpg);base64,/, "");
				console.log("b64: " + base64ImageContent);
				var blob = base64ToBlob(base64ImageContent, 'image/png');
				var formData = new FormData();
				formData.append('picture', blob);
				//var form_data = new FormData($('#uploadForm')[0]);
				//console.log(form_data);
				if (platform == 'twitter') {
					$.ajax({
						type: 'POST',
						url: 'https://ul.greenpeace.international/upload',
						processData: false,
						contentType: false,
						async: false,
						cache: false,
						data: formData,
						success: function(response) {
							console.log(response);
							//$("body").append('<a href="https://twitter.com/intent/tweet?text='+response+'%20Check%20out%20my%20AR%20Impact%21&source=webclient"><i class="fab fa-twitter"  data-size="large"></i></a>')
							window.location.href = 'https://twitter.com/intent/tweet?text=' + response + '%20Check%20out%20my%20AR%20Impact%21&source=webclient';

						},
						error: function(error) {
							console.log(error)
						}
					});
				} else if (platform == 'facebook') {
					$.ajax({
						type: 'POST',
						url: 'https://ul.greenpeace.international/upload',
						processData: false,
						contentType: false,
						async: false,
						cache: false,
						data: formData,
						success: function(response) {
							console.log(response);
							window.location.href = 'https://www.facebook.com/sharer/sharer.php?u=' + response + '&amp;src=sdkpreparse';

						},
						error: function(error) {
							console.log(error)
						}
					});
				}

			})
		}

		//////////////////////////////////////////////////////////////////////////////////
		//		Initialize a basic camera + lights
		//////////////////////////////////////////////////////////////////////////////////

		// Create a camera
		var camera = new THREE.PerspectiveCamera;
		scene.add(camera);

		// add lights to scene and dynamic camera based light
		var ambientLight = new THREE.AmbientLight(0x212223, 6);
		scene.add(ambientLight);
		var pointLight = new THREE.DirectionalLight(0xffffff, 4);
		pointLight.position.set(-.5, -12, 1.5)
		pointLight.castShadow = true;
		scene.add(pointLight);
		scene.add(pointLight.target);

		// init renderer
		var renderer = new THREE.WebGLRenderer({
			antialias: true,
			alpha: true,
			preserveDrawingBuffer: true // needed for screenshots
		});

		renderer.setPixelRatio(4);
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.domElement.style.position = 'absolute';
		renderer.domElement.style.top = '0px';
		renderer.domElement.style.left = '0px';
		renderer.shadowMapEnabled = true;
		renderer.shadowMapSoft = true;

		renderer.shadowCameraNear = 0.1;
		renderer.shadowCameraFar = 9999999999999;
		renderer.shadowCameraFov = 150;

		renderer.shadowMapBias = 0.0039;
		renderer.shadowMapDarkness = 0.2;
		renderer.shadowMapWidth = 1024;
		renderer.shadowMapHeight = 1024;
		document.body.appendChild(renderer.domElement);


		////////////////////////////////////////////////////////////////////////////////
		//          handle arToolkitSource
		////////////////////////////////////////////////////////////////////////////////

		var arToolkitSource = new THREEx.ArToolkitSource({
			// to read from the webcam
			sourceType: 'webcam',
			sourceWidth: 1980,
			sourceHeight: 1080
		})

		arToolkitSource.init(function onReady() {
			onResize()
		})

		// handle resize
		window.addEventListener('resize', function() {
			onResize()
		})

		function onResize() {
			arToolkitSource.onResizeElement();
			arToolkitSource.copyElementSizeTo(renderer.domElement)
			if (arToolkitContext.arController !== null) {
				arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
			}
		}
		////////////////////////////////////////////////////////////////////////////////
		//          initialize arToolkitContext
		////////////////////////////////////////////////////////////////////////////////


		// create atToolkitContext
		var arToolkitContext = new THREEx.ArToolkitContext({
			cameraParametersUrl: './assets/camera_para.dat',
			detectionMode: 'mono',
			maxDetectionRate: 60,
			canvasWidth: 80 * 3,
			canvasHeight: 60 * 3,
		})
		// initialize it
		arToolkitContext.init(function onCompleted() {
			// copy projection matrix to camera
			camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
		})

		// update artoolkit on every frame
		onRenderFcts.push(function() {
			if (arToolkitSource.ready === false) return
			arToolkitContext.update(arToolkitSource.domElement)
		})


		////////////////////////////////////////////////////////////////////////////////
		//          Create a ArMarkerControls
		////////////////////////////////////////////////////////////////////////////////

		var markerRoot = new THREE.Group
		scene.add(markerRoot)
		var artoolkitMarker = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
			type: 'pattern',
			patternUrl: './assets/patt.gp',
			size: 1
		})

		// build a smoothedControls
		var smoothedRoot = new THREE.Group()
		scene.add(smoothedRoot)
		var smoothedControls = new THREEx.ArSmoothedControls(smoothedRoot, {
			lerpPosition: 0.35,
			lerpQuaternion: 0.18,
			lerpScale: 1,
		})
		onRenderFcts.push(function(delta) {
			smoothedControls.update(markerRoot)
		})
		//////////////////////////////////////////////////////////////////////////////////
		//		add an object in the scene
		//////////////////////////////////////////////////////////////////////////////////

		var arWorldRoot = smoothedRoot;
		arWorldRoot.name = "arWorldRoot" // makes finding it easier

		var geometry = new THREE.SphereGeometry(0.3, 32, 32);
		var material = new THREE.MeshBasicMaterial({
			color: 0xffff00
		});
		var sphere = new THREE.Mesh(geometry, material);
		arWorldRoot.add(sphere);

		let mtlLoader = new THREE.MTLLoader();
		//let objLoader = new THREE.OBJLoader();

		function loadIsland(islandDirectory, islandName) {
			/* something like a docstring
					islandDirectory			str, path to directory that contains .mtl, .obj
					islandName					str, the name of the island files
					positions						array of length 3, containing xyz coords for placement
			*/
			mtlLoader.setTexturePath(islandDirectory)
			mtlLoader.setPath(islandDirectory)
			// load material
			mtlLoader.load(islandName + ".mtl", materials => {
				materials.preload()
				let objLoader = new THREE.OBJLoader();
				objLoader.setMaterials(materials)
				objLoader.setPath(islandDirectory)
				// load object
				objLoader.load(islandName + ".obj", object => {
					console.log(`currently loading ${islandName}`)
					console.log(object)
					object.traverse(node => {
						if (node instanceof THREE.Mesh) {
							node.geometry.computeVertexNormals()
						}
					})
					object.scale.set(...islands[islandName].scale)
					object.rotation.set(islands[islandName].rotation.x,islands[islandName].rotation.y,islands[islandName].rotation.z)
					object.position.set(...islands[islandName].position) // needs to be an array
					console.log(islands[islandName].scale, islands[islandName])
					object.name = islandName
					arWorldRoot.add(object)
					//model("island_forest").rotation.set(islands[islandName].rotation.x,islands[islandName].rotation.y,islands[islandName].rotation.z)
				})
			})
		}

		function loadTreesOnForestIsland(assetDirectory, treesHolder, nr) {
			var loadedTrees = [];
			Object.keys(trees).forEach(tree => {
				console.log(tree);
			})
		}

		function loadAssets(assetDirectory, assetName) {
			/* something like a docstring
					assetName 					Name of the Asset to load
					mtlLoader		 				THREE.MTLLoader instance
					islandDirectory			str, path to directory that contains .mtl, .obj
					islandName					str, the name of the island files
					positions						array of length 3, containing xyz coords for placement
			*/
			mtlLoader.setTexturePath(assetDirectory)
			mtlLoader.setPath(assetDirectory)
			// load material
			mtlLoader.load(assetName + ".mtl", materials => {
				materials.preload();
				let objLoader = new THREE.OBJLoader();
				objLoader.setMaterials(materials)
				objLoader.setPath(assetDirectory)
				// load object
				objLoader.load(assetName + ".obj", object => {
					console.log(`currently loading ${assetName}`)
					console.log(object)
					object.traverse(node => {
						if (node instanceof THREE.Mesh) {
							node.geometry.computeVertexNormals()
						}
					})
					object.scale.set(...trees[assetName].scale)
					spacefound = false;
					var calcdx;
					var calcdz;
					while (!spacefound) {
						potentialx = -1.3 + (Math.random());
						potentialz = -1.8 + (Math.random());
						if (treeposses.length > 0) {
							for (var j = 0; j < treeposses.length; j++) {
								var distance = distanceBetweenTwoPoints(potentialx, treeposses[j].x, potentialz, treeposses[j].z);
								if (distance > treespacing) {
									calcdx = potentialx;
									calcdz = potentialz;
									spacefound = true;
									console.log("positionfound!: " + distance)
								} else {
									console.log("looking for more space because too small: " + distance)
								}
							}
						} else {
							calcdx = potentialx;
							calcdz = potentialz;
							spacefound = true;
						}
					}
					object.position.set(calcdx, 0.4, calcdz)
					treeposses.push(object.position);
					console.log(trees[assetName])
					object.name = assetName
					arWorldRoot.add(object)
				})
			})
		}

		// iterate over all islands
		Object.keys(islands).forEach(island => {
			loadIsland("./assets/islands/", island)
		})

		// iterate over all trees
		Object.keys(trees).forEach(tree => {
			for (var i = 0; i < 5; i++) {
				loadAssets("./assets/trees/", tree)
			}
		})


		//////////////////////////////////////////////////////////////////////////////////
		//		render the whole thing on the page
		//////////////////////////////////////////////////////////////////////////////////

		// render the scene
		onRenderFcts.push(function() {
			renderer.render(scene, camera);
		})

		// object foo
		let islandDirections = {
			"island_forest": 1,
			"island_main": 1,
			"island_lake": 1
		}

		// run the rendering loop
		var lastTimeMsec = null
		requestAnimationFrame(function animate(nowMsec) {
			// keep looping
			requestAnimationFrame(animate);
			// lift or lower blinds based on whether marker is visible or not.
			if (markerRoot.visible) {
				$("#blinds").fadeOut(100);
				$("#ui").fadeIn();
			} else {
				$("#blinds").fadeIn();
				$("#ui").fadeOut(100);
			}
			// measure time
			lastTimeMsec = lastTimeMsec || nowMsec - 1000 / 60
			var deltaMsec = Math.min(200, nowMsec - lastTimeMsec)
			lastTimeMsec = nowMsec
			// call each update function
			onRenderFcts.forEach(function(onRenderFct) {
				onRenderFct(deltaMsec / 1000, nowMsec / 1000)
			})

			// iterate over all available islands
			let availableIslands = []
			// push all available islands to array
			scene.getObjectByName(arWorldRoot.name).children.forEach(obj => {
				if (obj.name !== "") {
					availableIslands.push(obj.name)
				}
			})

			// actual iteration
			availableIslands.forEach(island => {
				let islandModel = model(island)
				let dir = 1 // short direction variable name for convenience
				// switch-case:
				switch (island) {
					case "island_forest":
						if (islandModel.position.y < 2) {
							islandDirections[island] = 1
						} else if (islandModel.position.y > 2.4) {
							islandDirections[island] = -1
						}
						dir = islandDirections[island]
						islandModel.position.set(islandModel.position.x,
							islandModel.position.y + 0.001 * dir,
							islandModel.position.z)
						for (var i = 0; i < arWorldRoot.children.length; i++) {
							if (arWorldRoot.children[i].name.includes("tree")) {
								arWorldRoot.children[i].position.set(arWorldRoot.children[i].position.x,
									islandModel.position.y + 0.001 * dir,
									arWorldRoot.children[i].position.z)
							}
						}
						break;

					case "island_main":
						if (islandModel.position.y < 1.5) {
							islandDirections[island] = 1
						} else if (islandModel.position.y > 2.9) {
							islandDirections[island] = -1
						}
						dir = islandDirections[island]
						islandModel.position.set(islandModel.position.x,
							islandModel.position.y + 0.002 * dir,
							islandModel.position.z)
						break;

					case "island_lake":
						if (islandModel.position.y < 1.8) {
							islandDirections[island] = 1
						} else if (islandModel.position.y > 2.4) {
							islandDirections[island] = -1
						}
						dir = islandDirections[island]
						islandModel.position.set(islandModel.position.x,
							islandModel.position.y + 0.003 * dir,
							islandModel.position.z)
						break;

					default:
						//console.log(`entered default case for variable ${island}.`)
				}
			})
			date = Date.now() * 0.0006;
			pointLight.position.set(
				Math.cos(date) * orbitRadius,
				Math.sin(date) * orbitRadius,
				Math.sin(date) * orbitRadius
			);
			sphere.position.set(
				Math.cos(date) * orbitRadius,
				Math.sin(date) * orbitRadius,
				Math.sin(date) * orbitRadius
			);
			//console.log(pointLight.position);
		})

		///////////////////////////////////////////////////////////////////////////
		// 										 	CUSTOM FUNCTIONS 																 //
		///////////////////////////////////////////////////////////////////////////
		function animate() {
			console.log("placeholder function cause gabe forgot")
		}
		//Island Deleter
		//NOTE: does this need 'name' as a parameter?
		function deleteIslands() {
			for (var i = 0; i < arWorldRoot.children.length; i++) {
				if (arWorldRoot.children[i].name) {
					var toRemove = model(arWorldRoot.children[i].name);
					arWorldRoot.remove(toRemove);
					// animate();
				}
			}
		}

		function setGrassGreenness(greenness) {
			model("island_forest").children[0].material.color.r = 1 - greenness;
			model("island_forest").children[0].material.color.g = greenness * .7 + 0.3;
		}

		function setWaterClarity(clarity) {
			model("island_lake").children[0].material[3].color.r = 0;
			model("island_lake").children[0].material[3].color.g = clarity * 0.2;
			model("island_lake").children[0].material[3].color.b = clarity;
			model("island_lake").children[0].material[3].opacity = 1 - clarity * .3;
		}

		function distanceBetweenTwoPoints(x1, z1, x2, z2) {
			return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(z2 - z1, 2));
		}

		function model(name) {
			for (var i = 0; i < arWorldRoot.children.length; i++) {
				if (arWorldRoot.children[i].name == name) {
					return arWorldRoot.children[i];
				}
			}
		}

		function findMat(iname, tname) {
			materials = model(iname).children[0].material;
			for (var x = 0; x < materials.length; x++) {
				if (materials[x].name == tname) {
					return materials[x]
				}
			}
		}
		// stolen from https://github.com/jeromeetienne/AR.js/issues/358#issuecomment-395911581
		function captureVideoFrame(video, format, width, height) {
			if (typeof video === 'string') {
				video = document.querySelector(video)
			}

			format = format || 'jpeg'

			if (!video || (format !== 'png' && format !== 'jpeg')) {
				return false
			}

			let canvas = document.createElement("CANVAS")

			canvas.width = width || video.videoWidth
			canvas.height = height || video.videoHeight
			canvas.getContext('2d').drawImage(video, 0, 0)
			let dataUri = canvas.toDataURL('image/' + format)
			let data = dataUri.split(',')[1]
			let mimeType = dataUri.split(';')[0].slice(5)

			let bytes = window.atob(data)
			let buf = new ArrayBuffer(bytes.length)
			let arr = new Uint8Array(buf)

			for (let i = 0; i < bytes.length; i++) {
				arr[i] = bytes.charCodeAt(i)
			}

			let blob = new Blob([arr], {
				type: mimeType
			})
			return {
				blob: blob,
				dataUri: dataUri,
				format: format,
				width: canvas.width,
				height: canvas.height
			}
		}

		// stolen from https://github.com/jeromeetienne/AR.js/issues/358#issuecomment-404543089
		function resizeCanvas(origCanvas, width, height) {
			let resizedCanvas = document.createElement("canvas");
			let resizedContext = resizedCanvas.getContext("2d");

			resizedCanvas.height = height;
			resizedCanvas.width = width;

			if (width > height) {
				// Landscape
				resizedContext.drawImage(origCanvas, 0, 0, width, height);
			} else {
				// Portrait
				var scale = height / width;
				var scaledHeight = origCanvas.width * scale;
				var scaledWidth = origCanvas.height * scale;
				var marginLeft = (origCanvas.width - scaledWidth) / 2;
				resizedContext.drawImage(origCanvas, marginLeft, 0, scaledWidth, scaledHeight);
			}

			return resizedCanvas.toDataURL();
		}

		function initForm() {
			// Hide questions to begin with
			$("#boxyBox").hide();
			$("#questionTwo").hide();
			$("#questionThree").hide();
		}

		function Begin() {
			$("#formtitle").hide();
			$("#description").hide();
			$("#calculationBox").hide();
			$("#boxyBox").fadeIn();
		}


		// Question one's function (oil)
		function setOilToRange1() {
			oil = 1;
			$("#questionOne").hide();
			$("#questionTwo").fadeIn();

		}

		function setOilToRange2() {
			oil = 2;
			$("#questionOne").hide();
			$("#questionTwo").fadeIn();
		}

		function setOilToRange3() {
			oil = 3;
			$("#questionOne").hide();
			$("#questionTwo").fadeIn();
		}


		// Question two's function (plastic)
		function setPlasticToRange1() {
			plastic = 1;
			$("#questionTwo").hide();
			$("#questionThree").fadeIn();
		}

		function setPlasticToRange2() {
			plastic = 2;
			$("#questionTwo").hide();
			$("#questionThree").fadeIn();
		}

		function setPlasticToRange3() {
			plastic = 3;
			$("#questionTwo").hide();
			$("#questionThree").fadeIn();
		}


		// Question three's function (forest)
		function setForestToRange1() {
			oil = 1;
			$("#landing").fadeOut();
			$("#questionThree").fadeOut();
		}

		function setForestToRange2() {
			oil = 2;
			$("#landing").fadeOut();
			$("#questionThree").fadeOut();
		}

		function setForestToRange3() {
			oil = 3;
			$("#landing").fadeOut();
			$("#questionThree").fadeOut();
		}
	</script>
</body>

</html>
